name: Sync Draw.io Embed

on:
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/sync-drawio.yml'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g puppeteer
          npm install puppeteer

      - name: Download Draw.io embed with Puppeteer
        run: |
          cat > download-drawio.js << 'SCRIPT'
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');
          const https = require('https');

          const downloadedUrls = new Set();
          const urlToPath = new Map();

          function sanitizePath(url) {
            const parsed = new URL(url);
            let pathname = parsed.pathname;
            if (pathname === '/' || pathname === '') {
              pathname = '/index.html';
            }
            pathname = pathname.replace(/\?.*$/, '');
            return pathname;
          }

          async function downloadFile(url, destPath) {
            return new Promise((resolve, reject) => {
              const file = fs.createWriteStream(destPath);
              https.get(url, (response) => {
                if (response.statusCode === 302 || response.statusCode === 301) {
                  const redirectUrl = response.headers.location;
                  file.close();
                  fs.unlinkSync(destPath);
                  downloadFile(redirectUrl, destPath).then(resolve).catch(reject);
                  return;
                }
                response.pipe(file);
                file.on('finish', () => {
                  file.close();
                  resolve();
                });
              }).on('error', (err) => {
                fs.unlinkSync(destPath);
                reject(err);
              });
            });
          }

          (async () => {
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            
            const page = await browser.newPage();
            
            const outDir = path.join(process.cwd(), 'drawio-embed');
            if (fs.existsSync(outDir)) {
              fs.rmSync(outDir, { recursive: true });
            }
            fs.mkdirSync(outDir, { recursive: true });

            await page.setRequestInterception(true);
            
            page.on('request', (request) => {
              const url = request.url();
              if (url.startsWith('https://embed.diagrams.net/')) {
                const relativePath = sanitizePath(url);
                urlToPath.set(url, relativePath);
                downloadedUrls.add(url);
              }
              request.continue();
            });

            page.on('response', async (response) => {
              const url = response.url();
              
              if (!url.startsWith('https://embed.diagrams.net/')) {
                return;
              }

              if (response.status() !== 200) {
                return;
              }

              const contentType = response.headers()['content-type'] || '';
              const validTypes = [
                'text/html',
                'text/css',
                'application/javascript',
                'text/javascript',
                'application/json',
                'image/',
                'font/',
                'application/font'
              ];

              if (!validTypes.some(type => contentType.includes(type))) {
                return;
              }

              try {
                const relativePath = sanitizePath(url);
                const fullPath = path.join(outDir, relativePath);
                const dir = path.dirname(fullPath);
                
                if (!fs.existsSync(dir)) {
                  fs.mkdirSync(dir, { recursive: true });
                }

                if (contentType.includes('text/') || contentType.includes('application/javascript') || contentType.includes('application/json')) {
                  const text = await response.text();
                  fs.writeFileSync(fullPath, text, 'utf-8');
                  console.log(`Saved text file: ${relativePath}`);
                } else {
                  const buffer = await response.buffer();
                  fs.writeFileSync(fullPath, buffer);
                  console.log(`Saved binary file: ${relativePath}`);
                }
              } catch (error) {
                console.error(`Error saving ${url}:`, error.message);
              }
            });

            console.log('Loading Draw.io embed...');
            await page.goto('https://embed.diagrams.net/?embed=1&proto=json&ui=min&spin=1&libraries=1&saveAndExit=0&noSaveBtn=1&noExitBtn=1', {
              waitUntil: 'networkidle2',
              timeout: 60000
            });

            await page.waitForTimeout(10000);

            console.log('Scrolling to load lazy resources...');
            await page.evaluate(() => {
              window.scrollTo(0, document.body.scrollHeight);
            });
            await page.waitForTimeout(3000);

            await browser.close();

            console.log(`Downloaded ${downloadedUrls.size} unique URLs`);

            const indexPath = path.join(outDir, 'index.html');
            if (!fs.existsSync(indexPath)) {
              const possibleIndexes = fs.readdirSync(outDir).filter(f => f.endsWith('.html'));
              if (possibleIndexes.length > 0) {
                fs.copyFileSync(path.join(outDir, possibleIndexes[0]), indexPath);
              }
            }

            const versionInfo = {
              version: new Date().toISOString().split('T')[0].replace(/-/g, ''),
              synced: new Date().toISOString(),
              source: 'https://embed.diagrams.net',
              filesDownloaded: downloadedUrls.size
            };
            fs.writeFileSync(
              path.join(outDir, 'manifest.json'),
              JSON.stringify(versionInfo, null, 2)
            );

            console.log('Download complete!');
          })();
          SCRIPT

          node download-drawio.js

      - name: Create version file
        run: |
          VERSION=$(date +%Y%m%d)
          echo "DRAWIO_VERSION=$VERSION" >> $GITHUB_ENV
          
          cat > drawio-embed/VERSION.txt << EOF
          Draw.io Embed Mirror
          Synced: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Version: ${VERSION}
          Source: https://embed.diagrams.net
          Mirror: Automated via GitHub Actions with Puppeteer
          EOF

      - name: Verify download
        run: |
          if [ ! -f "drawio-embed/index.html" ]; then
            echo "ERROR: index.html not found!"
            ls -la drawio-embed/
            exit 1
          fi
          
          FILE_COUNT=$(find drawio-embed -type f | wc -l)
          if [ "$FILE_COUNT" -lt 5 ]; then
            echo "ERROR: Too few files downloaded ($FILE_COUNT)"
            exit 1
          fi
          
          echo "Successfully downloaded $FILE_COUNT files"
          echo "## Files Downloaded" >> $GITHUB_STEP_SUMMARY
          echo "Total: $FILE_COUNT" >> $GITHUB_STEP_SUMMARY

      - name: Check for changes
        id: check_changes
        run: |
          git add drawio-embed/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
            git diff --staged --stat
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add drawio-embed/
          git commit -m "Update Draw.io embed to version ${DRAWIO_VERSION} - $(date -u +"%Y-%m-%d")"
          git push

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'drawio-embed'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Summary
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "## Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${DRAWIO_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Files**: $(find drawio-embed -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY

name: Sync Draw.io Embed

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Download Light Theme
        run: |
          cat > download.js << 'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');

          const BASE = 'https://embed.diagrams.net';
          const THEME = process.argv[2] || 'light';
          const downloaded = new Set();
          const outDir = path.join(process.cwd(), 'drawio-embed', THEME);

          function sanitizePath(url) {
            let p = new URL(url).pathname;
            if (p === '/' || !p) p = '/index.html';
            return p.replace(/^\//, '');
          }

          (async () => {
            if (fs.existsSync(outDir)) fs.rmSync(outDir, { recursive: true });
            fs.mkdirSync(outDir, { recursive: true });

            const browser = await puppeteer.launch({ 
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            const page = await browser.newPage();

            page.on('response', async (response) => {
              const url = response.url();
              if (!url.startsWith(BASE)) return;
              if (downloaded.has(url)) return;
              if (response.status() !== 200) return;

              downloaded.add(url);
              const relPath = sanitizePath(url);
              const fullPath = path.join(outDir, relPath);
              const dir = path.dirname(fullPath);

              try {
                if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
                const buffer = await response.buffer();
                fs.writeFileSync(fullPath, buffer);
                console.log(`✓ ${relPath}`);
              } catch (err) {
                console.error(`✗ ${relPath}: ${err.message}`);
              }
            });

            const url = `${BASE}/?embed=1&proto=json&spin=1&libraries=1&saveAndExit=0&noSaveBtn=1&noExitBtn=1&stealth=1&offline=1&ui=${THEME}`;
            console.log(`Loading Draw.io with ${THEME} theme...`);
            console.log(`URL: ${url}`);
            
            await page.goto(url, {
              waitUntil: 'networkidle0',
              timeout: 120000
            });

            console.log('Waiting for dynamic loads...');
            await new Promise(resolve => setTimeout(resolve, 15000));

            await browser.close();

            console.log(`\n${THEME}: Downloaded ${downloaded.size} files`);
            
            fs.writeFileSync(
              path.join(outDir, 'manifest.json'),
              JSON.stringify({ 
                theme: THEME,
                synced: new Date().toISOString(),
                files: downloaded.size 
              }, null, 2)
            );

            process.exit(0);
          })().catch(err => {
            console.error('Error:', err);
            process.exit(1);
          });
          EOF

          node download.js light

      - name: Download Dark Theme
        run: |
          node download.js dark

      - name: Clean up integration files
        run: |
          for theme in light dark; do
            cd drawio-embed/$theme
            
            echo "Cleaning $theme theme..."
            rm -f cache 2>/dev/null || true
            rm -f github* 2>/dev/null || true
            rm -f gitlab* 2>/dev/null || true
            rm -f dropbox* 2>/dev/null || true
            rm -f onedrive* 2>/dev/null || true
            rm -f trello* 2>/dev/null || true
            rm -f js/dropbox-sdk.min.js 2>/dev/null || true
            rm -rf integrations/ 2>/dev/null || true
            
            find . -name "*\?*" -type f -delete
            
            mkdir -p images js styles
            
            if [ ! -f "images/manifest.json" ]; then
              echo '{"version":"mirror"}' > images/manifest.json
            fi
            
            if [ ! -f "js/PreConfig.js" ]; then
              echo "window.DRAWIO_CONFIG = {};" > js/PreConfig.js
            fi
            
            cd ../..
          done

      - name: Verify
        run: |
          for theme in light dark; do
            echo "Verifying $theme theme..."
            FILE_COUNT=$(find drawio-embed/$theme -type f | wc -l)
            echo "  Files: $FILE_COUNT"
            
            [ -f "drawio-embed/$theme/index.html" ] && echo "  ✓ index.html" || echo "  ✗ index.html MISSING"
            [ -f "drawio-embed/$theme/js/app.min.js" ] && echo "  ✓ app.min.js" || echo "  ✗ app.min.js MISSING"
            
            if [ ! -f "drawio-embed/$theme/index.html" ]; then
              echo "ERROR: $theme/index.html missing"
              exit 1
            fi
            echo ""
          done

      - name: Create version file
        run: |
          cat > drawio-embed/VERSION.txt << EOF
          Draw.io Embed Mirror
          Synced: $(date -u)
          Themes: light, dark (separate static builds)
          Light files: $(find drawio-embed/light -type f | wc -l)
          Dark files: $(find drawio-embed/dark -type f | wc -l)
          Configuration: embed=1, stealth=1, offline=1, no cloud integrations
          EOF

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add drawio-embed/
          git diff --staged --quiet || git commit -m "Update $(date +%Y-%m-%d)"
          git push || true

      - name: Deploy
        uses: actions/configure-pages@v4
        
      - name: Upload
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'drawio-embed'
          
      - name: Deploy Pages
        uses: actions/deploy-pages@v4

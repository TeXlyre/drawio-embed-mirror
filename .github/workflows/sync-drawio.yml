name: Sync Draw.io Embed

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download from embed.diagrams.net
        run: |
          mkdir -p drawio-embed
          cd drawio-embed
          
          curl -o index.html 'https://embed.diagrams.net/?embed=1&proto=json&spin=1'
          
          cat index.html | grep -oP '(src|href)="[^"]*"' | grep -oP '"[^"]*"' | tr -d '"' | while read url; do
            if [[ $url == //* ]]; then
              url="https:$url"
            elif [[ $url == /* ]]; then
              url="https://embed.diagrams.net$url"
            elif [[ ! $url == http* ]]; then
              continue
            fi
            
            if [[ $url == *embed.diagrams.net* ]]; then
              filepath=${url#https://embed.diagrams.net}
              filepath=${filepath#/}
              
              if [[ -z "$filepath" ]]; then
                continue
              fi
              
              mkdir -p "$(dirname "$filepath")"
              
              echo "Downloading: $filepath"
              curl -f -o "$filepath" "$url" 2>/dev/null || echo "Failed: $url"
            fi
          done

      - name: Fix paths in HTML
        run: |
          cd drawio-embed
          sed -i 's|https://embed.diagrams.net/|./|g' index.html
          sed -i 's|//embed.diagrams.net/|./|g' index.html

      - name: Create version file
        run: |
          cat > drawio-embed/VERSION.txt << EOF
          Synced: $(date -u)
          Source: https://embed.diagrams.net
          EOF

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add drawio-embed/
          git diff --staged --quiet || git commit -m "Update $(date +%Y-%m-%d)"
          git push

      - name: Deploy
        uses: actions/configure-pages@v4
        
      - name: Upload
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'drawio-embed'
          
      - name: Deploy
        uses: actions/deploy-pages@v4

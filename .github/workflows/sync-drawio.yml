name: Sync Draw.io Embed

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Download with Puppeteer
        run: |
          cat > download.js << 'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');
          const https = require('https');

          const BASE = 'https://embed.diagrams.net';
          const downloaded = new Set();
          const outDir = path.join(process.cwd(), 'drawio-embed');

          function sanitizePath(url) {
            let p = new URL(url).pathname;
            if (p === '/' || !p) p = '/index.html';
            return p.replace(/^\//, '');
          }

          function download(url, dest) {
            return new Promise((resolve, reject) => {
              https.get(url, (res) => {
                if (res.statusCode === 301 || res.statusCode === 302) {
                  download(res.headers.location, dest).then(resolve).catch(reject);
                  return;
                }
                const file = fs.createWriteStream(dest);
                res.pipe(file);
                file.on('finish', () => { file.close(); resolve(); });
                file.on('error', reject);
              }).on('error', reject);
            });
          }

          (async () => {
            if (fs.existsSync(outDir)) fs.rmSync(outDir, { recursive: true });
            fs.mkdirSync(outDir, { recursive: true });

            const browser = await puppeteer.launch({ 
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            const page = await browser.newPage();

            page.on('response', async (response) => {
              const url = response.url();
              if (!url.startsWith(BASE)) return;
              if (downloaded.has(url)) return;
              if (response.status() !== 200) return;

              downloaded.add(url);
              const relPath = sanitizePath(url);
              const fullPath = path.join(outDir, relPath);
              const dir = path.dirname(fullPath);

              try {
                if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
                const buffer = await response.buffer();
                fs.writeFileSync(fullPath, buffer);
                console.log(`✓ ${relPath}`);
              } catch (err) {
                console.error(`✗ ${relPath}: ${err.message}`);
              }
            });

            console.log('Loading Draw.io...');
            await page.goto(BASE + '/?embed=1&proto=json&spin=1&libraries=1&ui=min', {
              waitUntil: 'networkidle0',
              timeout: 120000
            });

            console.log('Waiting for dynamic loads...');
            await new Promise(resolve => setTimeout(resolve, 15000));

            await browser.close();

            console.log(`\nDownloaded ${downloaded.size} files`);
            
            fs.writeFileSync(
              path.join(outDir, 'manifest.json'),
              JSON.stringify({ 
                synced: new Date().toISOString(),
                files: downloaded.size 
              }, null, 2)
            );

            process.exit(0);
          })().catch(err => {
            console.error('Error:', err);
            process.exit(1);
          });
          EOF

          node download.js

      - name: Create missing files
        run: |
          cd drawio-embed
          
          mkdir -p images js styles
          
          if [ ! -f "images/manifest.json" ]; then
            echo '{"version":"mirror"}' > images/manifest.json
          fi
          
          if [ ! -f "js/PreConfig.js" ]; then
            echo "window.DRAWIO_CONFIG = {};" > js/PreConfig.js
          fi

      - name: Verify
        run: |
          FILE_COUNT=$(find drawio-embed -type f | wc -l)
          
          echo "Files: $FILE_COUNT"
          echo ""
          echo "Critical files:"
          [ -f "drawio-embed/index.html" ] && echo "  ✓ index.html" || echo "  ✗ index.html MISSING"
          [ -f "drawio-embed/js/app.min.js" ] && echo "  ✓ app.min.js" || echo "  ✗ app.min.js MISSING"
          [ -f "drawio-embed/js/bootstrap.js" ] && echo "  ✓ bootstrap.js" || echo "  ✗ bootstrap.js MISSING"
          
          if [ ! -f "drawio-embed/index.html" ]; then
            echo "ERROR: index.html missing"
            exit 1
          fi

      - name: Create version file
        run: |
          cat > drawio-embed/VERSION.txt << EOF
          Draw.io Embed Mirror
          Synced: $(date -u)
          Files: $(find drawio-embed -type f | wc -l)
          Method: Puppeteer (browser-based crawl)
          EOF

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add drawio-embed/
          git diff --staged --quiet || git commit -m "Update $(date +%Y-%m-%d)"
          git push || true

      - name: Deploy
        uses: actions/configure-pages@v4
        
      - name: Upload
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'drawio-embed'
          
      - name: Deploy Pages
        uses: actions/deploy-pages@v4

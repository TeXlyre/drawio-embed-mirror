name: Sync Draw.io Embed with Host

on:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: drawio-embed-sync
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Puppeteer
        run: npm install --no-save puppeteer

      - name: Mirror embed app
        run: |
          cat > download.js << 'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');

          const BASE = 'https://embed.diagrams.net';
          const ui = process.argv[2];
          const outName = process.argv[3];

          const downloaded = new Set();
          const outDir = path.join(process.cwd(), 'drawio-embed', outName);

          function relPathFromUrl(url) {
            const u = new URL(url);
            let p = u.pathname;
            if (p === '/' || !p) p = '/index.html';
            return p.replace(/^\//, '');
          }

          function safeWrite(filePath, data) {
            const dir = path.dirname(filePath);
            fs.mkdirSync(dir, { recursive: true });
            fs.writeFileSync(filePath, data);
          }

          function ensureStubs(themeDir) {
            const jsDir = path.join(themeDir, 'js');
            fs.mkdirSync(jsDir, { recursive: true });

            const pre = path.join(jsDir, 'PreConfig.js');
            if (!fs.existsSync(pre)) {
              fs.writeFileSync(pre, 'window.DRAWIO_CONFIG = window.DRAWIO_CONFIG || {};\n');
            }

            const post = path.join(jsDir, 'PostConfig.js');
            if (!fs.existsSync(post)) {
              fs.writeFileSync(post, '\n');
            }
          }

          function patchAppHtml(themeDir) {
            const appPath = path.join(themeDir, 'app.html');
            if (!fs.existsSync(appPath)) return;

            let html = fs.readFileSync(appPath, 'utf8');

            if (!/<base\s/i.test(html)) {
              html = html.replace(/<head([^>]*)>/i, '<head$1>\n<base href="./">');
            }

            html = html.replace(/\b(src|href)="\/(?!\/)/g, '$1="./');

            fs.writeFileSync(appPath, html);
          }

          (async () => {
            fs.rmSync(outDir, { recursive: true, force: true });
            fs.mkdirSync(outDir, { recursive: true });

            const browser = await puppeteer.launch({
              headless: 'new',
              args: [
                '--no-sandbox',
                '--disable-setuid-sandbox',
                '--disable-dev-shm-usage'
              ]
            });

            const page = await browser.newPage();

            page.on('response', async (response) => {
              try {
                const url = response.url();
                if (!url.startsWith(BASE)) return;
                if (downloaded.has(url)) return;

                const status = response.status();
                if (status < 200 || status >= 300) return;

                downloaded.add(url);

                const relPath = relPathFromUrl(url);
                const fullPath = path.join(outDir, relPath);

                let buffer = Buffer.alloc(0);
                try {
                  buffer = await response.buffer();
                } catch (_) {
                  buffer = Buffer.alloc(0);
                }

                safeWrite(fullPath, buffer);
                process.stdout.write(`✓ ${relPath}\n`);
              } catch (_) {}
            });

            const params =
              `embed=1&proto=json&spin=1&libraries=1&saveAndExit=0&noSaveBtn=1&noExitBtn=1` +
              `&db=0&od=0&gapi=0&tr=0&gh=0&gl=0&stealth=1&offline=1&ui=${encodeURIComponent(ui)}`;

            const url = `${BASE}/?${params}`;
            process.stdout.write(`\nLoading: ${url}\n\n`);

            await page.goto(url, { waitUntil: 'networkidle0', timeout: 120000 });
            await new Promise((r) => setTimeout(r, 15000));

            await browser.close();

            const indexPath = path.join(outDir, 'index.html');
            const appPath = path.join(outDir, 'app.html');

            if (!fs.existsSync(indexPath)) {
              throw new Error(`${outName}/index.html missing after download`);
            }

            fs.renameSync(indexPath, appPath);

            const redirectHtml =
              `<!doctype html><meta charset="utf-8">` +
              `<meta name="viewport" content="width=device-width,initial-scale=1">` +
              `<title>drawio-embed</title>` +
              `<script>location.replace("app.html?${params}");</script>` +
              `<noscript><a href="app.html?${params}">Open</a></noscript>`;

            safeWrite(indexPath, redirectHtml);

            ensureStubs(outDir);
            patchAppHtml(outDir);

            process.stdout.write(`\n${outName}: Downloaded ${downloaded.size} files\n`);
          })().catch((err) => {
            process.stderr.write(`Error: ${err && err.stack ? err.stack : err}\n`);
            process.exit(1);
          });
          EOF

          THEMES=("light:kennedy" "dark:dark")
          for entry in "${THEMES[@]}"; do
            IFS=: read -r theme ui <<< "$entry"
            node download.js "$ui" "$theme"
          done

          for theme in light dark; do
            mkdir -p "drawio-embed/$theme/resources"
            
            cat > "drawio-embed/$theme/service-worker.js" <<'EOF'
          self.addEventListener('install', () => { self.skipWaiting(); });
          self.addEventListener('activate', (e) => { e.waitUntil(self.clients.claim()); });
          self.addEventListener('fetch', () => {});
          EOF

            curl -fsSL -o "drawio-embed/$theme/shortcuts.svg" \
              "https://raw.githubusercontent.com/jgraph/drawio/dev/src/main/webapp/shortcuts.svg"
          done

          python3 - <<'PY'
          import json, os, sys, urllib.request

          api = "https://api.github.com/repos/jgraph/drawio/contents/src/main/webapp/resources?ref=dev"
          req = urllib.request.Request(api, headers={"Accept":"application/vnd.github+json","User-Agent":"gh-actions"})
          with urllib.request.urlopen(req, timeout=60) as r:
            items = json.loads(r.read().decode("utf-8"))

          out_dir = "drawio-embed/light/resources"
          os.makedirs(out_dir, exist_ok=True)

          urls = []
          for it in items:
            name = it.get("name","")
            if name.startswith("dia_") and name.endswith(".txt") and it.get("download_url"):
              urls.append((name, it["download_url"]))

          if not urls:
            sys.stderr.write("No dia_*.txt files found from GitHub API\n")
            sys.exit(1)

          for name, url in sorted(urls):
            req = urllib.request.Request(url, headers={"User-Agent":"gh-actions"})
            with urllib.request.urlopen(req, timeout=60) as r:
              data = r.read()
            with open(os.path.join(out_dir, name), "wb") as f:
              f.write(data)

          if os.path.exists("drawio-embed/light/resources/dia.txt") and not os.path.exists("drawio-embed/light/resources/dia_en.txt"):
            import shutil
            shutil.copyfile("drawio-embed/light/resources/dia.txt", "drawio-embed/light/resources/dia_en.txt")
          PY

          cp -r drawio-embed/light/resources/dia_*.txt drawio-embed/dark/resources/ 2>/dev/null || true

          python3 - <<'PY'
          import json, os, urllib.request

          def fetch_dir(api_url, out_dir):
            req = urllib.request.Request(api_url, headers={"Accept": "application/vnd.github+json", "User-Agent": "gh-actions"})
            with urllib.request.urlopen(req, timeout=60) as r:
              items = json.loads(r.read().decode("utf-8"))
            os.makedirs(out_dir, exist_ok=True)
            for it in items:
              if it["type"] == "file" and it.get("download_url"):
                req2 = urllib.request.Request(it["download_url"], headers={"User-Agent": "gh-actions"})
                with urllib.request.urlopen(req2, timeout=60) as r:
                  data = r.read()
                with open(os.path.join(out_dir, it["name"]), "wb") as f:
                  f.write(data)
              elif it["type"] == "dir":
                fetch_dir(it["url"], os.path.join(out_dir, it["name"]))

          api = "https://api.github.com/repos/jgraph/drawio/contents/src/main/webapp/plugins?ref=dev"
          for theme in ("light", "dark"):
            fetch_dir(api, f"drawio-embed/{theme}/plugins")
          PY

          mkdir -p drawio-embed/host

          cat > drawio-embed/host/index.html <<'EOF'
          <!doctype html>
          <meta charset="utf-8" />
          <meta name="viewport" content="width=device-width,initial-scale=1" />
          <title>drawio-embed</title>
          <style>
            html, body { height: 100%; margin: 0; }
            iframe { width: 100%; height: 100%; border: 0; display: block; }
          </style>
          <iframe id="editor" allow="clipboard-read; clipboard-write"></iframe>
          <script>
            const sp = new URLSearchParams(location.search);
            const theme = sp.get('theme') || 'light';
            const ui = theme === 'dark' ? 'dark' : 'kennedy';

            const params = new URLSearchParams({
              embed: '1',
              proto: 'json',
              spin: '1',
              libraries: '1',
              saveAndExit: '0',
              noSaveBtn: '1',
              noExitBtn: '1',
              db: '0',
              od: '0',
              gapi: '0',
              tr: '0',
              gh: '0',
              gl: '0',
              stealth: '1',
              offline: '1',
              ui
            });

            const iframe = document.getElementById('editor');
            iframe.src = `../${theme}/app.html?${params.toString()}`;

            function post(action, extra = {}) {
              iframe.contentWindow.postMessage(JSON.stringify({ action, ...extra }), '*');
            }

            function blankMxfile() {
              return '<mxfile host="app.diagrams.net"><diagram name="Page-1"></diagram></mxfile>';
            }

            window.addEventListener('message', (evt) => {
              let msg;
              try { msg = JSON.parse(evt.data); } catch { return; }
              if (!msg || typeof msg !== 'object') return;
              if (msg.event === 'init') {
                post('load', { xml: blankMxfile() });
              }
            });
          </script>
          EOF

          cat > drawio-embed/VERSION.txt << EOF
          Draw.io Embed Mirror
          Synced: $(date -u)
          Light files: $(find drawio-embed/light -type f 2>/dev/null | wc -l)
          Dark files: $(find drawio-embed/dark -type f 2>/dev/null | wc -l)
          Light languages: $(ls -1 drawio-embed/light/resources/dia_*.txt 2>/dev/null | wc -l)
          Dark languages: $(ls -1 drawio-embed/dark/resources/dia_*.txt 2>/dev/null | wc -l)
          Light plugins: $(ls -1 drawio-embed/light/plugins/*.js 2>/dev/null | wc -l)
          Dark plugins: $(ls -1 drawio-embed/dark/plugins/*.js 2>/dev/null | wc -l)
          EOF

      - name: Verify
        run: |
          for theme in light dark; do
            test -f "drawio-embed/$theme/index.html"
            test -f "drawio-embed/$theme/app.html"
            test -f "drawio-embed/$theme/js/PreConfig.js"
            test -f "drawio-embed/$theme/service-worker.js"
            test -f "drawio-embed/$theme/shortcuts.svg"
            test -f "drawio-embed/$theme/resources/dia_en.txt"
            test "$(ls -1 drawio-embed/$theme/resources/dia_*.txt 2>/dev/null | wc -l)" -ge 1
            test -f "drawio-embed/$theme/plugins/text.js"
            echo "✓ $theme theme ready ($(find drawio-embed/$theme -type f | wc -l) files, $(ls -1 drawio-embed/$theme/resources/dia_*.txt 2>/dev/null | wc -l) languages, $(ls -1 drawio-embed/$theme/plugins/*.js 2>/dev/null | wc -l) plugins)"
          done
          test -f "drawio-embed/host/index.html"
          echo "✓ host ready"

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add drawio-embed/
          git diff --staged --quiet || git commit -m "Update $(date +%Y-%m-%d)"
          git push || true

      - name: Deploy
        uses: actions/configure-pages@v4

      - name: Upload
        uses: actions/upload-pages-artifact@v3
        with:
          path: drawio-embed

      - name: Deploy Pages
        uses: actions/deploy-pages@v4

name: Sync Draw.io Embed with Host

on:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: drawio-embed-sync
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Puppeteer
        run: npm install --no-save puppeteer

      - name: Mirror embed app
        run: |
          bash .github/scripts/mirror_themes.sh "$GITHUB_WORKSPACE"
          python3 .github/scripts/fetch_assets.py

          cat > drawio-embed/VERSION.txt << EOF
          Draw.io Embed Mirror
          Synced: $(date -u)
          Light files: $(find drawio-embed/light -type f 2>/dev/null | wc -l)
          Dark files: $(find drawio-embed/dark -type f 2>/dev/null | wc -l)
          Light languages: $(ls -1 drawio-embed/light/resources/dia_*.txt 2>/dev/null | wc -l)
          Dark languages: $(ls -1 drawio-embed/dark/resources/dia_*.txt 2>/dev/null | wc -l)
          Light plugins: $(ls -1 drawio-embed/light/plugins/*.js 2>/dev/null | wc -l)
          Dark plugins: $(ls -1 drawio-embed/dark/plugins/*.js 2>/dev/null | wc -l)
          EOF

      - name: Verify
        run: |
          for theme in light dark; do
            for file in \
              "drawio-embed/$theme/index.html" \
              "drawio-embed/$theme/app.html" \
              "drawio-embed/$theme/js/PreConfig.js" \
              "drawio-embed/$theme/service-worker.js" \
              "drawio-embed/$theme/shortcuts.svg" \
              "drawio-embed/$theme/resources/dia_en.txt" \
              "drawio-embed/$theme/plugins/text.js" \
              "drawio-embed/$theme/images/github-logo.svg" \
              "drawio-embed/$theme/images/github-logo-white.svg"; do
              test -f "$file" || echo "MISSING: $file"
            done
            count=$(find "drawio-embed/$theme/resources" -name 'dia_*.txt' 2>/dev/null | wc -l)
            test "$count" -ge 1 || echo "MISSING: $theme dia_*.txt files (found $count)"
            echo "✓ $theme theme ready ($(find drawio-embed/$theme -type f | wc -l) files, $count languages, $(find drawio-embed/$theme/plugins -name '*.js' 2>/dev/null | wc -l) plugins)"
          done
          test -f "drawio-embed/host/index.html" || echo "MISSING: host/index.html"
          echo "✓ host ready"

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add drawio-embed/
          git diff --staged --quiet || git commit -m "Update $(date +%Y-%m-%d)"
          git push || true

      - name: Deploy
        uses: actions/configure-pages@v4

      - name: Upload
        uses: actions/upload-pages-artifact@v3
        with:
          path: drawio-embed

      - name: Deploy Pages
        uses: actions/deploy-pages@v4